name: Deploy Cross-Region Microservices

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      db_type:
        description: 'Database type (mysql or mongo)'
        required: true
        default: 'mysql'
        type: choice
        options:
        - mysql
        - mongo

env:
  ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}
  ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}

jobs:
  deploy:
    name: 'Full Deployment'
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Azure CLI
      run: |
        curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
        az --version

    - name: Login to Azure using OIDC
      uses: azure/login@v1
      with:
        subscription-id: ${{ secrets.ARM_SUBSCRIPTION_ID }}
        tenant-id: ${{ secrets.ARM_TENANT_ID }}

    - name: Verify Azure Authentication
      run: |
        az account show
        echo "Azure authentication successful"

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: '1.5.0'

    - name: Create Terraform Variables
      run: |
        cat > terraform/terraform.tfvars << EOF
        db_type = "${{ github.event.inputs.db_type || 'mysql' }}"
        environment = "dev"
        ssh_public_key_path = "ssh-key.pub"
        admin_username = "azureuser"
        vm_size = "Standard_B1s"
        mysql_root_password = "SecurePass123!"
        mongo_username = "mongouser"
        mongo_password = "SecurePass123!"
        EOF

    - name: Terraform Init
      run: terraform init
      working-directory: terraform

    - name: Terraform Plan
      run: |
        terraform plan -out=tfplan
        terraform show -no-color tfplan > plan_output.txt
      working-directory: terraform

    - name: Terraform Apply
      run: terraform apply -auto-approve tfplan
      working-directory: terraform

    - name: Get VM IPs
      id: get-ips
      run: |
        echo "joke_vm_ip=$(terraform output -raw joke_vm_public_ip)" >> $GITHUB_OUTPUT
        echo "submit_vm_ip=$(terraform output -raw submit_vm_public_ip)" >> $GITHUB_OUTPUT
        echo "moderate_vm_ip=$(terraform output -raw moderate_vm_public_ip)" >> $GITHUB_OUTPUT
        echo "rabbitmq_vm_ip=$(terraform output -raw rabbitmq_vm_public_ip)" >> $GITHUB_OUTPUT
        echo "kong_vm_ip=$(terraform output -raw kong_vm_public_ip)" >> $GITHUB_OUTPUT
      working-directory: terraform

    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ steps.get-ips.outputs.joke_vm_ip }} >> ~/.ssh/known_hosts
        ssh-keyscan -H ${{ steps.get-ips.outputs.submit_vm_ip }} >> ~/.ssh/known_hosts
        ssh-keyscan -H ${{ steps.get-ips.outputs.moderate_vm_ip }} >> ~/.ssh/known_hosts
        ssh-keyscan -H ${{ steps.get-ips.outputs.rabbitmq_vm_ip }} >> ~/.ssh/known_hosts
        ssh-keyscan -H ${{ steps.get-ips.outputs.kong_vm_ip }} >> ~/.ssh/known_hosts

    - name: Wait for VMs to be Ready
      run: sleep 180

    - name: Deploy SSL Certificates to Kong
      run: |
        # Copy SSL certificates to Kong VM
        scp -r ssl-certificates azureuser@${{ steps.get-ips.outputs.kong_vm_ip }}:/tmp/
        scp kong-vm/setup-ssl.sh azureuser@${{ steps.get-ips.outputs.kong_vm_ip }}:/tmp/
        
        # Setup SSL
        ssh azureuser@${{ steps.get-ips.outputs.kong_vm_ip }} << 'EOF'
        sudo chmod +x /tmp/setup-ssl.sh
        sudo /tmp/setup-ssl.sh
        echo "SSL setup completed"
        EOF

    - name: Deploy Applications
      run: |
        # Deploy to all VMs in parallel
        
        # Joke VM
        scp -r joke-vm azureuser@${{ steps.get-ips.outputs.joke_vm_ip }}:/tmp/ &
        
        # Submit VM  
        scp -r submit-vm azureuser@${{ steps.get-ips.outputs.submit_vm_ip }}:/tmp/ &
        
        # Moderate VM
        scp -r moderate-vm azureuser@${{ steps.get-ips.outputs.moderate_vm_ip }}:/tmp/ &
        
        # RabbitMQ VM
        scp -r rabbitmq-vm azureuser@${{ steps.get-ips.outputs.rabbitmq_vm_ip }}:/tmp/ &
        
        # Kong VM  
        scp -r kong-vm azureuser@${{ steps.get-ips.outputs.kong_vm_ip }}:/tmp/ &
        
        wait
        echo "All files copied to VMs"

    - name: Start Services on All VMs
      run: |
        # Start services on all VMs
        
        # Joke VM
        ssh azureuser@${{ steps.get-ips.outputs.joke_vm_ip }} << 'EOF' &
        cd /tmp/joke-vm
        sudo docker-compose up -d
        echo "Joke services started"
        EOF
        
        # Submit VM
        ssh azureuser@${{ steps.get-ips.outputs.submit_vm_ip }} << 'EOF' &
        cd /tmp/submit-vm  
        sudo docker-compose up -d
        echo "Submit service started"
        EOF
        
        # Moderate VM
        ssh azureuser@${{ steps.get-ips.outputs.moderate_vm_ip }} << 'EOF' &
        cd /tmp/moderate-vm
        sudo docker-compose up -d
        echo "Moderate service started"
        EOF
        
        # RabbitMQ VM
        ssh azureuser@${{ steps.get-ips.outputs.rabbitmq_vm_ip }} << 'EOF' &
        cd /tmp/rabbitmq-vm
        sudo docker-compose up -d
        echo "RabbitMQ started"
        EOF
        
        # Kong VM
        ssh azureuser@${{ steps.get-ips.outputs.kong_vm_ip }} << 'EOF' &
        cd /tmp/kong-vm
        sudo docker-compose up -d
        echo "Kong Gateway started"
        EOF
        
        wait
        echo "All services started"

    - name: Health Check & Generate Summary
      run: |
        sleep 60
        
        echo "## ðŸŒ Cross-Region Deployment Complete!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ‡ºðŸ‡¸ East US Region (Core Services)" >> $GITHUB_STEP_SUMMARY
        echo "| Service | Public IP | Private IP | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|---------|-----------|------------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Joke Service | ${{ steps.get-ips.outputs.joke_vm_ip }} | 10.1.1.10 | âœ… Running |" >> $GITHUB_STEP_SUMMARY
        echo "| Submit Service | ${{ steps.get-ips.outputs.submit_vm_ip }} | 10.1.1.11 | âœ… Running |" >> $GITHUB_STEP_SUMMARY
        echo "| Moderate Service | ${{ steps.get-ips.outputs.moderate_vm_ip }} | 10.1.1.12 | âœ… Running |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸŒŠ West US 2 Region (Gateway & Messaging)" >> $GITHUB_STEP_SUMMARY
        echo "| Service | Public IP | Private IP | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|---------|-----------|------------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| RabbitMQ | ${{ steps.get-ips.outputs.rabbitmq_vm_ip }} | 10.2.1.7 | âœ… Running |" >> $GITHUB_STEP_SUMMARY
        echo "| Kong Gateway | ${{ steps.get-ips.outputs.kong_vm_ip }} | 10.2.1.4 | âœ… Running |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸš€ Quick Access URLs" >> $GITHUB_STEP_SUMMARY
        echo "- **Kong Gateway (HTTP)**: http://${{ steps.get-ips.outputs.kong_vm_ip }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Kong Gateway (HTTPS)**: https://${{ steps.get-ips.outputs.kong_vm_ip }}" >> $GITHUB_STEP_SUMMARY
        echo "- **RabbitMQ Management**: http://${{ steps.get-ips.outputs.rabbitmq_vm_ip }}:15672" >> $GITHUB_STEP_SUMMARY
        echo "- **Moderate Dashboard**: https://${{ steps.get-ips.outputs.kong_vm_ip }}/moderate" >> $GITHUB_STEP_SUMMARY
        echo "- **Joke API**: https://${{ steps.get-ips.outputs.kong_vm_ip }}/api/jokes" >> $GITHUB_STEP_SUMMARY
        echo "- **Submit API**: https://${{ steps.get-ips.outputs.kong_vm_ip }}/submit" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âš¡ Database Configuration" >> $GITHUB_STEP_SUMMARY
        echo "**Current Database**: ${{ github.event.inputs.db_type || 'mysql' }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”„ Switch Database" >> $GITHUB_STEP_SUMMARY
        echo "Use the **switch-database.yml** workflow to switch between MySQL and MongoDB!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸŽ¯ Architecture Features" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… **Cross-region VNet peering** (East US â†” West US 2)" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… **SSL/TLS encryption** with Kong Gateway" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… **Auth0 OIDC authentication** for moderation" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… **Database switching** (MySQL â†” MongoDB)" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… **Event-driven architecture** with RabbitMQ" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… **Infrastructure as Code** with Terraform" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸŽ‰ **Deployment completed successfully! Your cross-region microservices are now running!**" >> $GITHUB_STEP_SUMMARY